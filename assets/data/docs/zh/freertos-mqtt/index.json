{"hash":"a79c60e1f44a7df053a4690e4cfebb76cc79c05a","data":{"doc":{"id":"039925bfe87e740cf455e4e3ef336b2e","title":"通过MQTT将Amazon FreeRTOS设备连接到Robonomics","description":"","contributors":["khssnv"],"headings":[],"subtitles":[{"depth":2,"value":"硬件设置","anchor":"#硬件设置"},{"depth":2,"value":"数据流","anchor":"#数据流"},{"depth":2,"value":"固件","anchor":"#固件"},{"depth":3,"value":"Wi-Fi配置","anchor":"#wi-fi配置"},{"depth":3,"value":"MQTT端点配置","anchor":"#mqtt端点配置"},{"depth":2,"value":"从MQTT到Robonomics","anchor":"#从mqtt到robonomics"},{"depth":2,"value":"使用的原始资源","anchor":"#使用的原始资源"}],"content":"\n这是一个演示，演示了如何通过MQTT将运行[Amazon Web Services FreeRTOS](https://aws.amazon.com/freertos/)的微控制器连接到Robonomics网络。请查看[此存储库](http://github.com/khssnv/freertos_mqtt_robonomics_example)以获取项目源代码。\n\n我们使用[ESP32 DevKitC](https://devices.amazonaws.com/detail/a3G0L00000AANtjUAH/ESP32-WROOM-32-DevKitC/)与由[Espressif IoT Development Framework](https://github.com/espressif/esp-idf)提供的FreeRTOS分发和MQTT实现，而Espressif是所使用的微控制器的供应商。\n\n还有一个[PMS-3003](http://www.plantower.com/en/content/?107.html)传感器用于演示目的。传感器测量空气中的颗粒物含量，人们可以使用它来估计空气质量。\n\n空气质量不是本文的主题，您可以在世界卫生组织的网站上找到更多相关信息：[环境（室外）空气污染](https://www.who.int/news-room/fact-sheets/detail/ambient-(outdoor)-air-quality-and-health)。该系统的目标是将传感器测量结果发布到Airalab的Robonomics网络。\n\n## 硬件设置\n\n我们将PMS3003的TXD引脚5连接到ESP32 DevKitC的IO17以通过UART传输测量数据。\n两个设备都需要电源和公共地。\n\n![Wiring Diagram](../images/freertos-mqtt/wiring.png)\n\n## 数据流\n\n为了将传感器测量结果传递到Robonomics网络，在固件级别上，我们的目标是通过传感器支持的嵌入式通信协议（在我们的案例中为UART）获取数据，并通过MQTT / TCP将其传递给AIRA实例。\n\n![Sending](../images/freertos-mqtt/send.svg)\n\n在我们的示例中，我们使用公共IP地址和域名分配的AIRA云部署。\n在AIRA实例上，我们设置`mosquitto` MQTT代理并订`/freertos_mqtt_robonomics_example/98:F4:AB:72:23:C4`主题以获取来自MQTT的消息。\n\n然后我们通过管道将消息传递给`robonomics io`写入器。\n\n![Receiving](../images/freertos-mqtt/recv.svg)\n\n现在数据在Robonomics网络中可用，我们可以再次使用`robonomics io`读取它。\n\n## 固件\n\n我们使用[带有TCP传输的ESP-MQTT示例应用程序](https://github.com/espressif/esp-idf/tree/master/examples/protocols/mqtt/tcp)作为基础。\n\n我们只修改`main/app_main.c`以进行与传感器的UART连接、SNTP时间同步和定期MQTT发布例程。\n\n如果您尝试重复该项目，并且这是您的第一个基于ESP IDF的项目，请首先按照[Espressif的ESP-IDF编程指南](https://docs.espressif.com/projects/esp-idf/en/latest/esp32/get-started/index.html#installation-step-by-step)介绍来熟悉固件操作，如配置、构建和使用`idf.py`工具上传。\n\n### Wi-Fi配置\n\n为了与部署在云中的AIRA实例通信，我们的微控制器需要互联网连接。\n我们使用ESP32的Wi-Fi进行连接。\nEspressif提供了配置板载Wi-Fi的工具。\n在我们的示例中，我们使用带有Ubuntu 20.04 GNU/Linux的开发环境。\n要配置Wi-Fi，我们进入项目文件夹并运行SDK配置工具。\n\n```console\ncd freertos_mqtt_robonomics_example/firmware\nidf.py menuconfig\n```\n\n然后我们在`Example 连接ion 配置`部分设置Wi-Fi接入点的SSID和密码。\n\n![Menuconfig Wi-Fi](../images/freertos-mqtt/menuconfig-wi-fi.png)\n\n### MQTT端点配置\n\n有两个要配置的MQTT事项。\n第一个是MQTT代理地址。\n可以使用SDK配置工具进行配置。\n\n```console\ncd freertos_mqtt_robonomics_example/firmware\nidf.py menuconfig\n```\n\n在`Example 配置`部分设置`Broker URL`。\n\n![Menuconfig MQTT](../images/freertos-mqtt/menuconfig-mqtt.png)\n\n第二个事项是MQTT主题。\n我们在固件中设置它，使用项目名称前缀后跟我们的ESP32 MAC地址。\n对于我们特定的微芯片，它给出了`/freertos_mqtt_robonomics_example/98:F4:AB:72:23:C4`。\n\n## 从MQTT到Robonomics\n\n首先让我们检查我们是否通过MQTT接收到数据。\n我们可以订阅我们的Mosquitto MQTT代理主题设备发布到。\n\n```console\n$ nix-shell -p mosquitto --run \"mosquitto_sub -h localhost -t '/freertos_mqtt_robonomics_example/98:F4:AB:72:23:C4'\"\nts=1615651809, PM1=2, PM2.5=6, PM10=3\n```\n\n在这里，我们将`mosquitto`软件包引入我们的环境中，以使用`mosquitto_sub`实用程序。\n然后，我们订阅固件中设置的主题。\n我们得到了我们的测量结果，这意味着AIRA通过MQTT正确接收数据。\n现在让我们将这些消息传输到Robonomics网络。\n\n```console\nnix-shell -p mosquitto --run \"mosquitto_sub -h localhost -t '/freertos_mqtt_robonomics_example/98:F4:AB:72:23:C4'\" | robonomics io write pubsub --bootnodes=/ip4/127.0.0.1/tcp/34333 /freertos_mqtt_robonomics_example\n```\n\n在这里，我们使用`robonomics`实用程序在pubsub频道`/freertos_mqtt_robonomics_example`中发布消息。\n我们指定`bootnodes`以确保至少建立一个连接。\n\n现在我们正在从同一个pubsub频道中读取这些消息。\n\n```console\n$ robonomics io read pubsub --listen /ip4/127.0.0.1/tcp/34333 /freertos_mqtt_robonomics_example\n2021-03-27 15:15:51  Generated random peer id: 12D3KooWB2nym5E6c3aPpnPKK5wB9Z6n9eZzcXSpyUBozxhi6dam\n2021-03-27 15:15:51  Subscribed to topic: _robonomics_pubsub_peer_discovery\n2021-03-27 15:15:51  Subscribed to topic: /freertos_mqtt_robonomics_example\n2021-03-27 15:15:56  New peer connected: PeerId(\"12D3KooWRPLCioD2b9XLZTZJQELSAuQAyTrHUKzRktrQHtTSs6kS\")\n2021-03-27 15:15:56  GRAFT: Mesh link added for peer: PeerId(\"12D3KooWRPLCioD2b9XLZTZJQELSAuQAyTrHUKzRktrQHtTSs6kS\") in topic: TopicHash { hash: \"_robonomics_pubsub_peer_discovery\" }\nts=1616843855, PM1=3, PM2.5=4, PM10=3\n```\n\n## 使用的原始资源\n\n* ESP32 DevKitC引脚图来自GoJimmy的博客 https://gojimmypi.blogspot.com/2017/03/jtag-debugging-for-esp32.html\n* PSM3003数据结构和解码器来自OpenAirProject https://github.com/openairproject/sensor-esp32\n\n**谢谢大家！**\n","tools":[],"fileInfo":{"path":"zh/freertos-mqtt.md","name":"freertos-mqtt"}}},"context":{}}