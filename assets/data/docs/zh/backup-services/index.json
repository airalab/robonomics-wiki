{"hash":"374e5e6bd3c921ba1dd42a764de57557a5b04902","data":{"doc":{"id":"2b128a2cdd0ead0b8f8d5a7d7d2ad237","title":"备份服务","description":"","contributors":["tubleronchik","LoSk-p"],"headings":[],"subtitles":[{"depth":2,"value":"创建Home Assistant配置的备份","anchor":"#创建home-assistant配置的备份"},{"depth":2,"value":"从备份中恢复Home Assistant配置","anchor":"#从备份中恢复home-assistant配置"},{"depth":2,"value":"恢复Home Assistant核心安装方法的Mosquitto和Zigbee2MQTT配置","anchor":"#恢复home-assistant核心安装方法的mosquitto和zigbee2mqtt配置"},{"depth":2,"value":"Home Assistant Docker安装方法的备份Mosquitto和Zigbee2MQTT配置","anchor":"#home-assistant-docker安装方法的备份mosquitto和zigbee2mqtt配置"},{"depth":2,"value":"备份按钮","anchor":"#备份按钮"}],"content":"\n**在本文中，您将学习如何生成Home Assistant配置的备份，并在需要时进行恢复。为了创建备份，调用一个服务来生成带有配置文件的安全存档。如果存在，该服务还会添加Mosquitto代理和Zigbee2MQTT配置到备份中。然后，该服务将存档添加到IPFS并将结果CID存储在Robonomics数字孪生中。**\n## 创建Home Assistant配置的备份\n\n创建备份可以在发生故障时轻松恢复Home Assistant配置。\n\n<robo-wiki-video autoplay loop controls :videos=\"[{src: 'QmZN5LfWR4XwAiZ3jEcw7xbCnT81NsF5XE3XFaNhMm5ba1', type:'mp4'}]\" />\n\n<robo-wiki-note type=\"warning\" title=\"警告\">\n\n为了备份和恢复配置，需要使用一个 **自定义IPFS网关** ，如Pinata。如果没有它，您的备份将仅存储在本地IPFS节点上，这可能会阻止您在本地节点故障时恢复Home Assistant配置。\n\n</robo-wiki-note>\n\n1. 在Home Assistant的Web界面中，转到 `Developer Tools` -> `Services`. 搜索 `Robonomics: Save Backup to Robonomics` 并点击 `CALL SERVICE`.\n\n2. 等待直到您看到通知 `Backup was updated in Robonomics` 出现在 `Notification`.\n\n<robo-wiki-note type=\"warning\" title=\"WARNING\">\n\n请勿在加载Home Assistant和Robonomics Integration后立即尝试创建备份或恢复配置。请 **等待约5分钟** 以完成初始设置。\n\n</robo-wiki-note>\n\n服务参数：\n- **完整备份**  (default: False) - 将数据库添加到备份中，以便存储实体状态的历史记录.\n- **Mosquitto密码文件的路径** (default: `/etc/mosquitto`) - 如果您使用Home Assistant Core或Docker安装方法，并且没有默认的Mosquitto代理路径，您应该更改此参数。 *Home Assistant OS或Superviser不需要*.\n\n## 从备份中恢复Home Assistant配置\n\n为了恢复配置，您需要安装Home Assistant和Robonomics Integration。 \n\n<robo-wiki-video autoplay loop controls :videos=\"[{src: 'QmNcJpHWWuZzwNCQryTw5kcki49oNTjEb8xvnfffSYfRVa', type:'mp4'}]\" />\n\n<robo-wiki-note type=\"warning\" title=\"WARNING\">\n\n为了确保在Home Assistant Core和Docker安装方法中成功恢复配置，您需要执行本页末尾所述的其他设置步骤。\n\n</robo-wiki-note>\n\n1. 使用所需的安装方法按照文章中的步骤安装Home Assistant与Robonomics Integration（如果尚未安装） [期望的安装方法](https://wiki.robonomics.network/docs/robonomics-smart-home-overview/#start-here-your-smart-home).\n\n2. [设置Robonomics集成](https://wiki.robonomics.network/docs/robonomics-hass-integration)使用您在之前的 Robonomics 配置中使用的 **相同的种子**。 如果您的订阅已结束，[重新激活](https://wiki.robonomics.network/docs/sub-activate).\n\n\n3. 在 Home Assistant 的 Web 界面中，转到`Developer Tools` -> `Services`。 搜索“Robonomics: Restore from the Backup in Robonomics`，`CALL SERVICE`。 导航到`Overview`页面，检查备份的状态。\n\n4. 恢复后，Home Assistant会自动重启。 如果由于某种原因 Home Assistant 没有重新启动，您可以通过监视 `robonomics.backup` 实体的状态来检查恢复状态。 如果状态为 `restored`，您将需要导航到 `Settings` > `System` 并单击右上角的 `RESTART` 按钮来手动重新启动 Home Assistant。\n \n5. 如果您的备份包括Zigbee2MQTT或Mosquitto配置，您需要重新启动这些服务以启用新的配置。您可以通过逐个重新启动服务来手动执行此操作，或者您可以简单地重新启动Home Assistant计算机以确保所有服务都重新启动。\n\n如果您使用的是Home Assistant Core或Docker安装方法，并且没有默认的Mosquitto brocker路径，您应该更改此参数。\n\nService arguments:\n- **Path to mosquitto password file** (default: `/etc/mosquitto`) - 如果您使用的是Home Assistant Core或Docker安装方法，并且没有默认的Mosquitto brocker路径，您应该更改此参数。*Home Assistant OS或Superviser不需要*\n- **Zigbee2MQTT 配置的路径**  (default: `/opt/zigbee2mqtt`) - 如果您使用 Home Assistant Core 或 Docker 安装方法并且没有 Zigbee2MQTT 的默认路径，则应更改此参数。 *Home Assistant OS或Superviser不需要*\n\n## 恢复Home Assistant核心安装方法的Mosquitto和Zigbee2MQTT配置\n\n如果备份包含 Mosquitto 或 Zigbee2MQTT 的配置，则在恢复过程中，它们将被放置在默认路径或参数中指定的路径中。 但是，如果您在现有 Home Assistant Core  *(不是从预安装的 Robonomics 映像中)* 安装了 Robonomics 集成，则 `homeassistant` 用户可能无权访问此路径。\n\n因此，要恢复 Mosquitto 和 Zigbee2MQTT 的配置，您需要向用户“homeassistant”授予必要的读取权限：\n```bash\nsudo chmod a+w /opt/zigbee2mqtt /etc/mosquitto\n```\n\n## Home Assistant Docker安装方法的备份Mosquitto和Zigbee2MQTT配置\n\n要从 Docker 容器备份 Mosquitto 和 Zigbee2MQTT 配置，您需要为其各自的配置创建卷。 这可以通过使用附加参数运行 Home Assistant 容器来实现：\n\n```bash\ndocker run -d \\\n  --name homeassistant \\\n  --privileged \\\n  --restart=unless-stopped \\\n  -e TZ=MY_TIME_ZONE \\\n  -v /PATH_TO_YOUR_CONFIG:/config \\\n  -v /etc/mosquitto:/etc/mosquitto \\\n  -v /etc/mosquitto:/opt/zigbee2mqtt \\\n  --network=host \\\n  ghcr.io/home-assistant/home-assistant:stable\n```\n\n或在 `compose.yaml` 文件中进行更改：\n\n```yaml\nversion: '3'\nservices:\n  homeassistant:\n    container_name: homeassistant\n    image: \"ghcr.io/home-assistant/home-assistant:stable\"\n    volumes:\n      - /PATH_TO_YOUR_CONFIG:/config\n      - /etc/localtime:/etc/localtime:ro\n      - /etc/mosquitto:/etc/mosquitto\n      - /etc/mosquitto:/opt/zigbee2mqtt\n    restart: unless-stopped\n    privileged: true\n    network_mode: host\n```\n<robo-wiki-note type=\"note\" title=\"Note\">\n\n请注意，Mosquitto 和 Zigbee2MQTT 配置的默认路径分别是 `/etc/mosquitto` 和 `/opt/zigbee2mqtt`。 但是，这些路径可能会根据您的具体设置而有所不同。\n\n</robo-wiki-note>\n\n## 备份按钮\n\n除了使用服务处理备份之外，您还可以使用 Robonomics 集成中的 `button.create_backup` 和`button.restore_from_backup` 按钮来简化流程。 这些按钮使用默认参数调用相应的服务（备份按钮创建没有历史记录的备份）。\n\n<robo-wiki-video autoplay loop controls :videos=\"[{src: 'Qmc1fexYaJMsK6ch6JhjL6aqnAwqYNAzo5nEwYgDpnp4gj', type:'mp4'}]\" />\n\n要将按钮添加到仪表板，请按照下列步骤操作：\n\n1. 点击仪表板右上角的三个点。\n2. 选择 `Edit Dashboard`.\n3. 单击右下角的 `Add Card` 按钮。\n4. 选择 `Entities` 卡。\n5. 在 `Entities` 字段中，搜索button.create_backup 和button.restore_from_backup 实体。\n6. 按 `Save` 将实体添加到卡中。\n7. 单击右上角的 `Done` 按钮完成编辑。\n\n\n","tools":["Robonomics Home Assistant Integration 1.4.2 https://github.com/airalab/homeassistant-robonomics-在部分中，超时是以秒为单位的，它将创建包含以下信息的数据日志：tegration"],"fileInfo":{"path":"zh/backup-services.md","name":"backup-services"}}},"context":{}}