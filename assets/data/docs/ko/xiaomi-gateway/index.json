{"hash":"007e15ba7e31f844e21c451ab2bf9e6a64540d2c","data":{"doc":{"id":"6961694edaf46a6adf4f9ad8a26ce5d0","title":"Connect Sensors with Xiaomi Gateway","contributors":["LoSk-p","dergudzon","Leemo94"],"translated":false,"headings":[],"subtitles":[{"depth":2,"value":"Add Gateway to Home Assistant","anchor":"#add-gateway-to-home-assistant"},{"depth":2,"value":"Add Gateway to Home Assistant using Homekit Controller integration","anchor":"#add-gateway-to-home-assistant-using-homekit-controller-integration"},{"depth":2,"value":"Configuration file","anchor":"#configuration-file"}],"content":"\nYou need your Xiaomi gateway along with all the sensors to be connected to the Mi Home app. If you haven't done this yet press `+` button on the top right corner, find your hub (it must be in connecting mode which is achieved via a long press of the power button) and follow instructions in the app. After you add the gateway, you need to add sensors: press on your gateway, then go to `Child device` and press `+`. Find required device and follow the instructions on the screen. For more details refer to the user manual of your Xiaomi Gateway hub.\n\n## Add Gateway to Home Assistant\nBe sure that you're logged in you raspberry as `homeassistant` user, if not do the following:\n```bash\nsudo -u homeassistant -H -s\n```\n\nIn your Home Assistant:\n```\nhttp://<raspberry_address>:8123\n```\nGo to `Configuration/Integrations` and press `Add Intagration`. There you need to Find `Xiaomi Miio`:\n\n![integration](../images/home-assistant/integration.png)\n\nThen fill your username (or phone) and password from Mi Home account and choose your country server:\n\n![auth](../images/home-assistant/auth.png)\n\nPress `Submit` and choose your Hub (Aqara Hub in this example):\n\n![hub](../images/home-assistant/hub.png)\n\nPress `Submit` and you will be able to see your gateway in Integrations page.\n\n## Add Gateway to Home Assistant using Homekit Controller integration\n\nYou can also connect your hub to Aqara Home app on ios and then add it to Home Assistant through Homekit Controller integration. \n\nAdd your hub to the app using `add device` or `+` button. Right after your hub added to Aqara Home app you will be proposed to bind it with your Homekit account. \n\n![homekit](../images/home-assistant/homekit.png)\n\nWhen you see a menu like the picture, open your Home Assistant page:\n\n```\nhttp://<raspberry_address>:8123\n```\nGo to `Configuration/Integrations`. Here you can find your device discovered and click `Configure` button to add it by Homekit Controller integration. You have to enter pairing code of your device, which you can find on the sticker on your device.\n\n![configure1](../images/home-assistant/configure1.png)\n\n![configure2](../images/home-assistant/configure2.png)\n\n\n## Configuration file\n\nThen we need to setup action to send data to Robonomics. For that open a configuration file:\n\n```bash\nnano ~/.homeassistant/configuration.yaml\n```\n\nAnd add following to the end of the file (full config file you can find [here](https://github.com/airalab/robonomics-smarthome/blob/main/configuration.yaml)):\n\n```\nautomation:\n  - alias: \"send_datalog_temperature_sensor\"\n    trigger:\n      platform: time_pattern\n      minutes: \"/5\"\n    action:\n      service: shell_command.send_datalog_temperature_sensor\n\n  - alias: \"send_datalog_contact_sensor\"\n    trigger:\n      platform: state\n      entity_id:\n        - binary_sensor.contact_sensor\n    action:\n      service: shell_command.send_datalog_contact_sensor\n\nshell_command:\n  send_datalog_temperature_sensor: 'python3 python_scripts/send_datalog.py sensor_humidity={{ states(\"sensor.temperature_sensor_humidity\") }} sensor_temp={{ states(\"sensor.temperature_sensor_temperature\") }} sensor_battery={{ states(\"sensor.temperature_sensor_battery\") }}'\n  send_datalog_contact_sensor: 'python3 python_scripts/send_datalog.py sensor_contact={{ states(\"binary_sensor.contact_sensor\") }}'\n```\n\nYou can choose how often you want to send data with changing the value in `minutes: \"/5\"`.\n\n>The names of the data in `shell_command` and `entity_id` like `sensor.temperature_sensor_humidity` or `binary_sensor.contact_sensor` may be different. You can find your option in `Configuration/Entities`. Find your sensor and copy Entity ID.\n>\n>![entity_id](../images/home-assistant/entity_id.png)\n\nAnd restart Home Assistant:\n```bash\nsystemctl restart home-assistant@homeassistant.service\n```\n You can add the data from sensors to your homepage like in `Home Assistant setup` in the description to [Method 1](/docs/zigbee2MQTT/).\n\nYou can see the data in [subscan](https://robonomics.subscan.io/), find your account and you will see datalog transactions. Data looks like this:\n\n![datalog_data](../images/home-assistant/datalog_data.png)\n\nYou can decrypt it with script [decrypt.py](https://github.com/airalab/robonomics-smarthome/blob/main/python_scripts/decrypt.py), download it:\n\n```bash\ncd /srv/homeassistant/python_scripts\nwget https://raw.githubusercontent.com/airalab/robonomics-smarthome/main/python_scripts/decrypt.py\n```\nAnd run with the data from datalog:\n```bash\ncd /srv/homeassistant/\nsource bin/activate\npython3 python_scripts/decrypt.py <data>\n```"}},"context":{}}