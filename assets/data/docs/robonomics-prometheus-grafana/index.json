{"hash":"7b36d9e87c2c85c3a4883ee5903b2777de09f139","data":{"doc":{"id":"517fd4db2d5dacbe91f138fdd1ce214d","title":"Robonomics + Prometheus + Grafana","headings":[{"value":"Robonomics + Prometheus + Grafana"}],"subtitles":[{"depth":1,"value":"Robonomics + Prometheus + Grafana","anchor":"#robonomics--prometheus--grafana"},{"depth":3,"value":"Introduction","anchor":"#introduction"},{"depth":3,"value":"Prerequisites","anchor":"#prerequisites"},{"depth":3,"value":"Step 1 — Creating Service Users","anchor":"#step-1--creating-service-users"},{"depth":3,"value":"Step 2 — Downloading Prometheus","anchor":"#step-2--downloading-prometheus"},{"depth":3,"value":"Step 3 — Configuring Prometheus","anchor":"#step-3--configuring-prometheus"},{"depth":3,"value":"Step 4 — Running Prometheus","anchor":"#step-4--running-prometheus"},{"depth":3,"value":"Step 5 — Downloading Node Exporter","anchor":"#step-5--downloading-node-exporter"},{"depth":3,"value":"Step 6 — Running Node Exporter","anchor":"#step-6--running-node-exporter"},{"depth":3,"value":"Step 7 — Configuring Prometheus to Scrape Node Exporter","anchor":"#step-7--configuring-prometheus-to-scrape-node-exporter"},{"depth":3,"value":"Step 8 - Adding Robonomic build in node_exporter","anchor":"#step-8---adding-robonomic-build-in-node_exporter"},{"depth":3,"value":"Step 9 - Setting up Grafana","anchor":"#step-9---setting-up-grafana"},{"depth":3,"value":"References","anchor":"#references"}],"content":"# Robonomics + Prometheus + Grafana\n\n> The following instruction is provided by [Hubo Bubo](https://github.com/hubobubo)\n>\n> The original article is located [here](https://github.com/hubobubo/robonomics/wiki/Robonomics-(XRT)-metrics-using-Prometheus-and-Grafana)\n\n### Introduction\nTo better monitor and maintain Robonomics node(s) it's good to setup a monitoring based on Prometheus Server and Grafana. This doc will show how to configure each one of it to fully monitor your node.\n\n###  Prerequisites\n* [Server Setup with Ubuntu 18.04](https://www.digitalocean.com/community/tutorials/initial-server-setup-with-ubuntu-18-04) \n* [Robonomics parachain collator installed](https://blog.aira.life/installing-and-running-the-robonomics-validator-in-the-polkadot-network-487ad4c1a567)\n* Make sure you have robonomics.service working on your machine and port 9615 is reachable \n\n### Step 1 — Creating Service Users\n\nFor security purposes, we’ll begin by creating two new user accounts, prometheus and node_exporter. Create these two users, and use the _--no-create-home_ and _--shell /bin/false_ options so that these users can’t log into the server.\n```\nsudo useradd --no-create-home --shell /bin/false prometheus\nsudo useradd --no-create-home --shell /bin/false node_exporter\n```\n\nBefore we download the Prometheus binaries, create the necessary directories for storing Prometheus’ files and data. Following standard Linux conventions, we’ll create a directory in _/etc_ for Prometheus’ configuration files and a directory in _/var/lib_ for its data.\n```\nsudo mkdir /etc/prometheus\nsudo mkdir /var/lib/prometheus\n```\nNow, set the user and group ownership on the new directories to the prometheus user.\n```\nsudo chown prometheus:prometheus /etc/prometheus\nsudo chown prometheus:prometheus /var/lib/prometheus\n```\n### Step 2 — Downloading Prometheus\n\nFirst, download and unpack the current stable version of Prometheus into your home directory. You can find the latest binaries on the [Prometheus download page.](https://prometheus.io/download/)\n\n```\nwget https://github.com/prometheus/prometheus/releases/download/v2.21.0/prometheus-2.21.0.linux-amd64.tar.gz\n```\nNow, unpack the downloaded archive.\n```\ntar xvf prometheus-2.21.0.linux-amd64.tar.gz\n```\nThis will create a directory called prometheus-2.21.0.linux-amd64 containing two binary files (prometheus and promtool), _consoles_ and _console_libraries_ directories containing the web interface files, a license, a notice, and several example files.\n\nCopy the two binaries to the _/usr/local/bin_ directory.\n```\nsudo cp prometheus-2.21.0.linux-amd64/prometheus /usr/local/bin/\nsudo cp prometheus-2.21.0.linux-amd64/promtool /usr/local/bin/\n```\nSet the user and group ownership on the binaries to the prometheus user created in Step 1.\n```\nsudo chown prometheus:prometheus /usr/local/bin/prometheus\nsudo chown prometheus:prometheus /usr/local/bin/promtool\n````\nCopy the consoles and _console_libraries_ directories to _/etc/prometheus_.\n```\nsudo cp -r prometheus-2.21.0.linux-amd64/consoles /etc/prometheus\nsudo cp -r prometheus-2.21.0.linux-amd64/console_libraries /etc/prometheus\n```\nSet the user and group ownership on the directories to the prometheus user. Using the -R flag will ensure that ownership is set on the files inside the directory as well.\n```\nsudo chown -R prometheus:prometheus /etc/prometheus/consoles\nsudo chown -R prometheus:prometheus /etc/prometheus/console_libraries\n```\nNow that Prometheus is installed, we’ll create its configuration and service files in preparation of its first run.\n\n### Step 3 — Configuring Prometheus\nIn the _/etc/prometheus_ directory, use nano or your favorite text editor to create a configuration file named _prometheus.yml_.\n```\nsudo nano /etc/prometheus/prometheus.yml\n```\nIn the global settings, define the default interval for scraping metrics. Note that Prometheus will apply these settings to every exporter unless an individual exporter’s own settings override the globals.\n```\nglobal:\n  scrape_interval: 15s\n```\nThis scrape_interval value tells Prometheus to collect metrics from its exporters every 15 seconds, which is long enough for most exporters.\nNow, add Prometheus itself to the list of exporters to scrape from with the following scrape_configs directive:\n```\n...\nscrape_configs:\n  - job_name: 'prometheus'\n    scrape_interval: 5s\n    static_configs:\n      - targets: ['localhost:9090']\n```\nPrometheus uses the _job_name_ to label exporters in queries and on graphs, so be sure to pick something descriptive here.\n\nAnd, as Prometheus exports important data about itself that you can use for monitoring performance and debugging, we’ve overridden the global scrape_interval directive from 15 seconds to 5 seconds for more frequent updates.\n\nLastly, Prometheus uses the _static_configs_ and _targets_ directives to determine where exporters are running. Since this particular exporter is running on the same server as Prometheus itself, we can use localhost instead of an IP address along with the default port, 9090.\n\nYour configuration file should now look like this:\n```\nglobal:\n  scrape_interval: 15s\n\nscrape_configs:\n  - job_name: 'prometheus'\n    scrape_interval: 5s\n    static_configs:\n      - targets: ['localhost:9090']\n```\nSave the file and exit your text editor.\n\nNow, set the user and group ownership on the configuration file to the prometheus user created in Step 1.\n```\nsudo chown prometheus:prometheus /etc/prometheus/prometheus.yml\n```\nWith the configuration complete, we’re ready to test Prometheus by running it for the first time.\n### Step 4 — Running Prometheus\nStart up Prometheus as the _prometheus_ user, providing the path to both the configuration file and the data directory.\n```\nsudo -u prometheus /usr/local/bin/prometheus \\\n    --config.file /etc/prometheus/prometheus.yml \\\n    --storage.tsdb.path /var/lib/prometheus/ \\\n    --web.console.templates=/etc/prometheus/consoles \\\n    --web.console.libraries=/etc/prometheus/console_libraries\n```\nThe output contains information about Prometheus’ loading progress, configuration file, and related services. It also confirms that Prometheus is listening on port _9090_.\n```\n_log output_\nSep 14 17:55:53 robonomics systemd[1]: Started Prometheus.\nSep 14 17:55:53 robonomics prometheus[29488]: level=info ts=2020-09-14T15:55:53.347Z caller=main.go:310 msg=\"No time or size retention was set so using the default time retention\" duration=15d\nSep 14 17:55:53 robonomics prometheus[29488]: level=info ts=2020-09-14T15:55:53.350Z caller=main.go:346 msg=\"Starting Prometheus\" version=\"(version=2.21.0, branch=HEAD, revision=e83ef207b6c2398919b69cd87d2693cfc2fb4127)\"\nSep 14 17:55:53 robonomics prometheus[29488]: level=info ts=2020-09-14T15:55:53.351Z caller=main.go:347 build_context=\"(go=go1.15.2, user=root@a4d9bea8479e, date=20200911-11:35:02)\"\nSep 14 17:55:53 robonomics prometheus[29488]: level=info ts=2020-09-14T15:55:53.351Z caller=main.go:348 host_details=\"(Linux 4.15.0-112-generic #113-Ubuntu SMP Thu Jul 9 23:41:39 UTC 2020 x86_64 robonomics (none))\"\nSep 14 17:55:53 robonomics prometheus[29488]: level=info ts=2020-09-14T15:55:53.351Z caller=main.go:349 fd_limits=\"(soft=1024, hard=4096)\"\nSep 14 17:55:53 robonomics prometheus[29488]: level=info ts=2020-09-14T15:55:53.351Z caller=main.go:350 vm_limits=\"(soft=unlimited, hard=unlimited)\"\nSep 14 17:55:53 robonomics prometheus[29488]: level=info ts=2020-09-14T15:55:53.357Z caller=main.go:701 msg=\"Starting TSDB ...\"\nSep 14 17:55:53 robonomics prometheus[29488]: level=info ts=2020-09-14T15:55:53.368Z caller=web.go:523 component=web msg=\"Start listening for connections\" address=0.0.0.0:9090\nSep 14 17:55:53 robonomics prometheus[29488]: level=info ts=2020-09-14T15:55:53.372Z caller=head.go:644 component=tsdb msg=\"Replaying on-disk memory mappable chunks if any\"\nSep 14 17:55:53 robonomics prometheus[29488]: level=info ts=2020-09-14T15:55:53.373Z caller=head.go:658 component=tsdb msg=\"On-disk memory mappable chunks replay completed\" duration=12.659µs\nSep 14 17:55:53 robonomics prometheus[29488]: level=info ts=2020-09-14T15:55:53.373Z caller=head.go:664 component=tsdb msg=\"Replaying WAL, this may take a while\"\nSep 14 17:55:53 robonomics prometheus[29488]: level=info ts=2020-09-14T15:55:53.380Z caller=head.go:716 component=tsdb msg=\"WAL segment loaded\" segment=0 maxSegment=1\nSep 14 17:55:53 robonomics prometheus[29488]: level=info ts=2020-09-14T15:55:53.381Z caller=head.go:716 component=tsdb msg=\"WAL segment loaded\" segment=1 maxSegment=1\nSep 14 17:55:53 robonomics prometheus[29488]: level=info ts=2020-09-14T15:55:53.381Z caller=head.go:719 component=tsdb msg=\"WAL replay completed\" checkpoint_replay_duration=48.125µs wal_replay_duration=8.253748ms total_replay_duration=8.343335ms\nSep 14 17:55:53 robonomics prometheus[29488]: level=info ts=2020-09-14T15:55:53.383Z caller=main.go:721 fs_type=EXT4_SUPER_MAGIC\nSep 14 17:55:53 robonomics prometheus[29488]: level=info ts=2020-09-14T15:55:53.384Z caller=main.go:724 msg=\"TSDB started\"\nSep 14 17:55:53 robonomics prometheus[29488]: level=info ts=2020-09-14T15:55:53.384Z caller=main.go:850 msg=\"Loading configuration file\" filename=/etc/prometheus/prometheus.yml\nSep 14 17:55:53 robonomics prometheus[29488]: level=info ts=2020-09-14T15:55:53.384Z caller=main.go:881 msg=\"Completed loading of configuration file\" filename=/etc/prometheus/prometheus.yml totalDuration=908.135µs remote_storage=6.693µs web_handler=819ns query_engine=1.383µs scrape=400.232µs scrape_sd=41.679µs notify=1.1µs notify_sd=1.847µs rules=1.522µs\nSep 14 17:55:53 robonomics prometheus[29488]: level=info ts=2020-09-14T15:55:53.384Z caller=main.go:673 msg=\"Server is ready to receive web requests.\"\n```\nIf you get an error message, double-check that you’ve used YAML syntax in your configuration file and then follow the on-screen instructions to resolve the problem.\n\nNow, halt Prometheus by pressing _CTRL+C_, and then open a new _systemd_ service file.\n```\nsudo nano /etc/systemd/system/prometheus.service\n```\nThe service file tells _systemd_ to run Prometheus as the prometheus user, with the configuration file located in the _/etc/prometheus/prometheus.yml_ directory and to store its data in the _/var/lib/prometheus_ directory.Copy the following content into the file:\n```\n[Unit]\nDescription=Prometheus\nWants=network-online.target\nAfter=network-online.target\n\n[Service]\nUser=prometheus\nGroup=prometheus\nType=simple\nExecStart=/usr/local/bin/prometheus \\\n    --config.file /etc/prometheus/prometheus.yml \\\n    --storage.tsdb.path /var/lib/prometheus/ \\\n    --web.console.templates=/etc/prometheus/consoles \\\n    --web.console.libraries=/etc/prometheus/console_libraries\n\n[Install]\nWantedBy=multi-user.target\n```\nFinally, save the file and close your text editor. To use the newly created service, reload systemd.\n```\nsudo systemctl daemon-reload\n```\nYou can now start Prometheus using the following command:\n```\nsudo systemctl start prometheus\n```\nTo make sure Prometheus is running, check the service’s status.\n```\nsudo systemctl status prometheus\n```\nThe output tells you Prometheus’ status, main process identifier (PID), memory use, and more.\n\nIf the service’s status isn’t active, follow the on-screen instructions and re-trace the preceding steps to resolve the problem before continuing the tutorial.\n```\n* prometheus.service - Prometheus\n   Loaded: loaded (/etc/systemd/system/prometheus.service; enabled; vendor preset: enabled)\n   Active: active (running) since Mon 2020-09-14 17:59:48 CEST; 24h ago\n Main PID: 29650 (prometheus)\n    Tasks: 9 (limit: 4915)\n   CGroup: /system.slice/prometheus.service\n           `-29650 /usr/local/bin/prometheus --config.file /etc/prometheus/prometheus.yml --storage.tsdb.path /var/lib/prometheus/ --web.console.templates=/etc/prometheus/consoles --web.console.libraries=/etc/prometheus/console_libraries\n```\nWhen you’re ready to move on, press _Q_ to quit the status command. Lastly, enable the service to start on boot.\n```\nsudo systemctl enable prometheus\n```\nNow that Prometheus is up and running, we can install an additional exporter to generate metrics about our server’s resources.\n### Step 5 — Downloading Node Exporter\nTo expand Prometheus beyond metrics about itself only, we’ll install an additional exporter called Node Exporter. Node Exporter provides detailed information about the system, including CPU, disk, and memory usage. Download the current stable version of Node Exporter into your home directory. You can find the latest binaries on [Prometheus download page.](https://prometheus.io/download/)\n```\nwget https://github.com/prometheus/node_exporter/releases/download/v1.0.1/node_exporter-1.0.1.linux-amd64.tar.gz\n```\nNow, unpack the downloaded archive.\n```\ntar xvf node_exporter-1.0.1.linux-amd64.tar.gz\n```\nThis will create a directory called _node_exporter-1.0.1.linux-amd64_ containing a binary file named _node_exporter_, a license, and a notice.\n\nCopy the binary to the _/usr/local/bin_ directory and set the user and group ownership to the node_exporter user that you created in Step 1.\n```\nsudo cp node_exporter-1.0.1.linux-amd64/node_exporter /usr/local/bin\nsudo chown node_exporter:node_exporter /usr/local/bin/node_exporter\n```\nNow that you’ve installed Node Exporter, let’s test it out by running it before creating a service file for it so that it starts on boot.\n### Step 6 — Running Node Exporter\nThe steps for running Node Exporter are similar to those for running Prometheus itself. Start by creating the Systemd service file for Node Exporter.\n```\nsudo nano /etc/systemd/system/node_exporter.service\n```\nCopy the following content into the service file:\n```\n[Unit]\nDescription=Node Exporter\nWants=network-online.target\nAfter=network-online.target\n\n[Service]\nUser=node_exporter\nGroup=node_exporter\nType=simple\nExecStart=/usr/local/bin/node_exporter --collector.systemd\n\n[Install]\nWantedBy=multi-user.target\n```\nSave the file and close your text editor. Finally, reload systemd to use the newly created service.\n```\nsudo systemctl daemon-reload\n```\nYou can now run Node Exporter using the following command:\n```\nsudo systemctl start node_exporter\n```\nVerify that Node Exporter’s running correctly with the status command.\n```\nsudo systemctl status node_exporter\n```\nLike before, this output tells you Node Exporter’s status, main process identifier (PID), memory usage, and more. If the service’s status isn’t active, follow the on-screen messages and re-trace the preceding steps to resolve the problem before continuing.\n```\n_Output_\n* node_exporter.service - Node Exporter\n   Loaded: loaded (/etc/systemd/system/node_exporter.service; enabled; vendor preset: enabled)\n   Active: active (running) since Mon 2020-09-14 17:58:25 CEST; 1 day 1h ago\n Main PID: 29612 (node_exporter)\n    Tasks: 7 (limit: 4915)\n   CGroup: /system.slice/node_exporter.service\n           `-29612 /usr/local/bin/node_exporter --collector.systemd\n```\nLastly, enable Node Exporter to start on boot.\n```\nsudo systemctl enable node_exporter\n```\nWith Node Exporter fully configured and running as expected, we’ll tell Prometheus to start scraping the new metrics.\n### Step 7 — Configuring Prometheus to Scrape Node Exporter\nBecause Prometheus only scrapes exporters which are defined in the scrape_configs portion of its configuration file, we’ll need to add an entry for Node Exporter, just like we did for Prometheus itself. Open the configuration file.\n```\nsudo nano /etc/prometheus/prometheus.yml\n```\nAt the end of the scrape_configs block, add a new entry called node_exporter.\n```\n...\n  - job_name: 'node_exporter'\n    scrape_interval: 5s\n    static_configs:\n      - targets: ['localhost:9100']\n```\nBecause this exporter is also running on the same server as Prometheus itself, we can use localhost instead of an IP address again along with Node Exporter’s default port, 9100. Your whole configuration file should look like this:\n```\nglobal:\n  scrape_interval: 15s\n\nscrape_configs:\n  - job_name: 'prometheus'\n    scrape_interval: 5s\n    static_configs:\n      - targets: ['localhost:9090']\n  - job_name: 'node_exporter'\n    scrape_interval: 5s\n    static_configs:\n      - targets: ['localhost:9100']\n```\nSave the file and exit your text editor when you’re ready to continue. Finally, restart Prometheus to put the changes into effect.\n```\nsudo systemctl restart prometheus\n```\nOnce again, verify that everything is running correctly with the status command.\n```\nsudo systemctl status prometheus\n```\nIf the service’s status isn’t set to active, follow the on screen instructions and re-trace your previous steps before moving on.\n```\nOutput\n* prometheus.service - Prometheus\n   Loaded: loaded (/etc/systemd/system/prometheus.service; enabled; vendor preset: enabled)\n   Active: active (running) since Tue 2020-09-15 19:06:56 CEST; 2s ago\n Main PID: 19725 (prometheus)\n    Tasks: 8 (limit: 4915)\n   CGroup: /system.slice/prometheus.service\n           `-19725 /usr/local/bin/prometheus --config.file /etc/prometheus/prometheus.yml --storage.tsdb.path /var/lib/prometheus/ --web.console.templates=/etc/prometheus/consoles --web.console.libraries=/etc/prometheus/console_libraries\n```\nWe now have Prometheus and Node Exporter installed, configured, and running. \n### Step 8 - Adding Robonomic build in node_exporter \nAfter successfully installed Prometheus and node_exporter we will have to use build in prometheus exporter in every substrate project. To make this happen we have to add additional entry to _/etc/prometheus/prometheus.yml_. \nOpen the configuration file.\n```\nsudo nano /etc/prometheus/prometheus.yml\n```\nAt the end of the scrape_configs block, add a new entry called robonomic_exporter.\n``` \n  - job_name: 'robonomics_exporter'\n    scrape_interval: 5s\n    static_configs:\n      - targets: ['localhost:9615']\n```\nSave the file and exit your text editor. Your whole configuration file should look like this:\n```\nglobal:\n  scrape_interval: 15s\n\nscrape_configs:\n  - job_name: 'prometheus'\n    scrape_interval: 5s\n    static_configs:\n      - targets: ['localhost:9090']\n  - job_name: 'node_exporter'\n    scrape_interval: 5s\n    static_configs:\n      - targets: ['localhost:9100']\n  - job_name: 'robonomics_exporter'\n    scrape_interval: 5s\n    static_configs:\n      - targets: ['localhost:9615']\n```\nFinally, restart Prometheus to put the changes into effect.\n```\nsudo systemctl restart prometheus\n```\nOnce again, verify that everything is running correctly with the status command.\n```\nsudo systemctl status prometheus\n```\nWe now have _Prometheus_ and _Node Exporter_ as well as _Robonomic Exporter_ installed, configured, and running. Now move on to Grafana\n### Step 9 - Setting up Grafana\nThe last step is to connect Prometheus as a Data Source in Grafana. For purpose of this tutorial we will use free cloud-based grafana which allow to have up to 5 dashboards as well as dedicated [Robonomics dashboard](https://grafana.com/grafana/dashboards/13015). Simply go to [grafana.com](https://grafana.com/) create new account and login to your newly created grafana instance.\n\nAt the beginning we must add to Grafana new _**Data Source**_ which in our case will be Prometheus server.\nGo to Data Source:\n\n>![DataSource](./images/prometheus-grafana/grafana-6-2020-09-15-19-18-50-Window.png)\n\nThen click **_Add data source_**\n\n>![DataSource](./images/prometheus-grafana/grafana-7-2020-09-15-19-18-50-Window.png)\n\nNext select _**Prometheus**_\n\n>![DataSource](./images/prometheus-grafana/grafana-8-2020-09-15-19-18-50-Window.png)\n\nIn new screen put your **_Prometheus server IP adress with 9090 port_**\n\n> ![DataSource](./images/prometheus-grafana/grafana-9-2020-09-15-19-18-50-Window.png)\n\nAfter that _**Save & Test**_ if you did all steps you should be green and ready to go for importing dashboard. On the main site click to **+** and then **Import** as shown on the pic below:\n\n> ![Import dashboard](./images/prometheus-grafana/grafana-1-2020-09-15-19-18-50-Window.png)\n\nThen you should see Import page:\n\n> ![Import page](./images/prometheus-grafana/grafana-2-2020-09-15-19-18-50-Window.png)\n\nIn the _Grafana.com dashboard url or id_ write _**13015**_ (as this is ID of the Robonomic dashboard)\n\n> ![Import Robonomic dashboard](./images/prometheus-grafana/grafana-3-2020-09-15-19-18-50-Window.png)\n\nAfter loading external dashboard you will get this screen:\n\n> ![XRT 13015 dashboard import](./images/prometheus-grafana/grafana-4-2020-09-15-19-18-50-Window.png)\n\nThe last step is to choose previously created **_Data Source_** and click _**Import**_\n\n> ![Prometheus as a DataSource](./images/prometheus-grafana/grafana-5-2020-09-15-19-18-50-Window.png)\n\nTHAT'S IT ! At this point you should see imported dashboard. \n\n\n### References\n```\nhttps://www.digitalocean.com/community/tutorials/how-to-install-prometheus-on-ubuntu-16-04\nhttps://medium.com/htc-research-engineering-blog/build-a-monitoring-dashboard-by-prometheus-grafana-741a7d949ec2\nhttps://prometheus.io/docs/visualization/grafana/\nhttps://prometheus.io/docs/guides/node-exporter/\nhttps://prometheus.io/docs/prometheus/latest/querying/basics/\nhttps://substrate.dev/docs/en/tutorials/visualize-node-metrics/\nhttps://github.com/paritytech/substrate/tree/master/utils/prometheus\nhttps://github.com/w3f/polkadot-dashboard\nhttps://grafana.com/grafana/dashboards/12425\nhttps://grafana.com/grafana/dashboards/11074\nhttps://grafana.com/grafana/dashboards/13015\n```\n\n"}},"context":{}}