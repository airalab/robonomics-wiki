---
title: Тестовый набор Substrate Cumulus Parachain для межцепочечной передачи сообщений

contributors: [ddulesov, boogerwooger, tubleronchik] 
---

Основная цель этого проекта - упрощение разработки времени выполнения парачейн, когда используются межцепочечные сообщения. Это позволяет разрабатывать код времени выполнения с интеграционными тестами с высокой степенью повторяемости и простым использованием. Он автоматизирует построение, создание предварительно настроенной конфигурации сети (т. е. 1 ретрансляционная цепь + 2 парачейна), настройку каналов передачи сообщений между парачейнами и запуск тестов передачи сообщений, отправку сообщений с использованием вызова времени выполнения, все создано и составлено на Python.

Тестовый набор XCM используется для тестирования производственного цикла Robobank - набора палетов Substrate, которые позволяют роботам регистрироваться на внешних парачейнах, получать предоплаченные заказы, выполнять их и получать платежи с использованием внешних токенов. Это позволяет роботам работать в сети Robonomics со всей необходимой инфраструктурой, но в то же время предлагать свои услуги на любом другом парачейне.

Пример видео доступен на [YouTube](https://www.youtube.com/watch?v=S_bZgsxngiM)

Основные шаги в демонстрационном сценарии:
- запуск ретрансляционной цепи и двух парачейнов в пакете из 6 процессов
- настройка каналов передачи сообщений XCM между парачейнами
- регистрация робота в обоих парачейнах
- создание заказа для этого робота в клиентском парачейне (резервирование платежа за выполнение заказа)
- отправка сообщения XCM на парачейн Robonomics
- создание "зеркальной" записи заказа на парачейне Robonomics
- робот принимает заказ на парачейне Robonomics
- отправка сообщения XCM об принятии заказа обратно в клиентский парачейн
- принятие заказа на клиентском парачейне (резервирование штрафного сбора за невыполнение заказа до срока)
- робот завершает заказ на парачейне Robonomics
- отправка сообщения XCM о завершении заказа в клиентский парачейн
- урегулирование всех платежей (платеж клиента переводится роботу, а также неиспользованный штрафной сбор)
- закрытие заказа

## Верховный поток
Этот проект является форком
[Шаблона узла Substrate Developer Hub](https://github.com/substrate-developer-hub/substrate-node-template).
Он содержит код времени выполнения палетов, которые тестируются.
Как в оригиналеКод parachains находится в каталогах "./pallets", "./runtime", "./node".

Отличия от исходного "substrate-node-template":
- этот коллаторный runtime имеет модуль обработчика HRMP и может обрабатывать сообщения от соседних parachains
- готовый к использованию тестовый runtime для внутренних тестов XCM

## Сборка и Запуск
Рекомендуемая (очень) конфигурация: 
```
Ubuntu 20, 16 Гб ОЗУ, 8 ЦП, 120 Гб SSD
```
[ПРИМЕЧАНИЕ] Первая сборка может занять много времени, до нескольких часов на неоптимальных машинах.

[ПРИМЕЧАНИЕ] Скрипт работает с ФИКСИРОВАННЫМИ версиями (хэшами коммитов) Polkadot(Rococo) в реле и parachains.

[ПРИМЕЧАНИЕ] По умолчанию скрипт каждый раз создает одну и ту же среду при запуске, удаляя все предыдущие состояния. Это поведение можно изменить в "config.sh", используя параметр "PERSISTENT".

Запустите сборку и настройку скрипта.  
```bash
git clone https://github.com/airalab/xcm-robobank-prototype.git
cd xcm-robobank-prototype
./scripts/init.sh
```

Основные действия скрипта "init.sh":
 - считывает конфигурацию (файл "config.sh" с номером ревизии, начальными ключами узлов и идентификаторами, параметром сохранения chaindata и т. д.)
 - устанавливает пакеты ОС, Rust и Python
 - создает отдельные бинарные файлы для реле-цепи и для обеих parachains
    - бинарные файлы будут сгенерированы в подкаталоге ./bin. 
 - (необязательно) удаляет все предыдущие данные цепочек
    - отключено, если "PERSISTENT=1" установлено в "config.sh"
 - запускает как отдельные процессы (с отдельными PID и каналами ввода-вывода):
    - валидаторы реле-цепи (т. е. 4 валидатора, работающих на стабильной ревизии Rococo)
    - коллаторы для parachain-100 (т. е. один коллатор для первой parachain, над которой вы работаете)
    - коллаторы для parachain-200 (т. е. один коллатор для второй parachain, над которой вы работаете)
 - выводит все конечные точки, порты в консоль, позволяя вам изучать любую цепочку с помощью приложений frontend (explorer, DApp)
 - продолжает выводить все данные всех цепочек в консоль

[ПРЕДУПРЕЖДЕНИЕ] После запуска подождите, пока сеть поднимется, убедитесь, что началась финализация блока и что parachains зарегистрированы. Эти процессы должны бытьТребуется примерно 5 минут (50 блоков x 6 секунд).

## Проверка работы начальной настройки

Используйте стандартный интерфейс Polkadot и сгенерированные конечные точки "--ws-port" для подключения к каждому узлу.
Откройте [приложение Polkadot](https://polkadot.js.org/apps/?rpc=ws://localhost:9500/) для мониторинга цепочек.

### Пример:
Локальный хост, 4 валидатора ретрансляционной цепи, один коллатор для парачейна-100, один коллатор для парачейна-200:
- [Валидатор ретрансляционной цепи 1](https://polkadot.js.org/apps/?rpc=ws://localhost:9500/)
- [Валидатор ретрансляционной цепи 2](https://polkadot.js.org/apps/?rpc=ws://localhost:9501/)
- [Валидатор ретрансляционной цепи 3](https://polkadot.js.org/apps/?rpc=ws://localhost:9502/)
- [Валидатор ретрансляционной цепи 4](https://polkadot.js.org/apps/?rpc=ws://localhost:9503/)
- [Коллатор парачейна-100](https://polkadot.js.org/apps/?rpc=ws://localhost:10054/)
- [Коллатор парачейна-200](https://polkadot.js.org/apps/?rpc=ws://localhost:10055/)

Если все работает и консенсус начался, мы можем перейти к запуску наших тестовых случаев (в новом терминале).

### Тестирование передачи сообщений UMP
```bash
./scripts/init.sh ump
```
Этот скрипт создает сообщение `Balance.transfer` в `парачейне-100` и передает его в ретрансляционную цепь.
Когда ретрансляционная цепь получает сообщение, она переведет 15 токенов со счета `пара 100` на счет Чарли.

### Тестирование передачи сообщений HRMP
```bash
./scripts/init.sh ump
```

Этот скрипт создает сообщение `Balance.transfer` в `парачейне-100` и передает его в `соседний 200`.
Перед этим он наделяет счет `сабл 100` 1000 токенами и устанавливает канал связи между парачейнами.
```bash
./scripts/init.sh hrmp
```
Следующие сообщения могут быть отправлены, запустив подкоманду `hrmpm`. Она не создает канал, поэтому работает быстрее.
```bash
./scripts/init.sh hrmpm
```

### Дополнительные опции
```bash
./scripts/init.sh help
```

## Локальная тестовая сеть### Создание настраиваемой спецификации цепочки
```
./bin/polkadot build-spec --chain rococo-local --disable-default-bootnode > rococo_local.json
```

Отредактируйте файл rococo_local.json, заменив параметры балансов и авторитетов на свои.
```json
  "keys": [
    [
      "",
      "",
      {
        "grandpa": "",
        "babe": "",
        "im_online": "",
        "para_validator": "",
        "para_assignment": "",
        "authority_discovery": ""
      }
    ]
```

Полкадот-адрес для //Alice//stash (криптография sr25519).
```bash
$ polkadot key inspect-key --scheme sr25519 --network substrate //Alice//stash
```

```text
Секретный ключ URI `//Alice//stash` принадлежит аккаунту:
Секретное значение:      

Публичный ключ (hex): 

ID аккаунта:       

SS58 Адрес:     
```

Ключ сессии grandpa для Полкадота для //Alice (криптография ed25519).
```bash
$ polkadot key inspect-key --scheme ed25519 --network substrate //Alice
```
```text
Секретный ключ URI `//Alice` принадлежит аккаунту:
Секретное значение:      

Публичный ключ (hex): 

ID аккаунта:       

SS58 Адрес:     
```

Полкадот-адрес для //Alice (криптография sr25519).
```
$ polkadot key inspect-key --scheme sr25519 --network substrate //Alice
```
```text
Секретный ключ URI `//Alice` принадлежит аккаунту:
Секретное значение:      

Публичный ключ (hex): 

ID аккаунта:       

SS58 Адрес:     
```

Преобразование rococo_local.json в формат raw.
```
./bin/polkadot build-spec --chain rococo_local.json --raw --disable-default-bootnode > rococo_local.json
```
Для использования новой спецификации цепочки замените файл rococo.json в каталоге ./config/ на этот новый и перезапустите цепочку.
```bash
./scripts/init.sh run
```
Вы можете свободно редактировать код. Вышеприведенная команда пересоберет проект и обновит узел коллатора перед запуском.
Cumulus - это предварительная версия программного обеспечения, которая все еще находится в активной разработке.
Мы используем конкретный коммит Polkadot [46c826f595021475fa5dbcd0987ed53f104e6e15  18 мар 2021](https://github.com/paritytech/polkadot/tree/46c826f595021475fa5)dbcd0987ed53f104e6e15)

Вы можете использовать более новые версии программного обеспечения. Для этого измените  POLKADOT_COMMIT  в ./scipt/config.sh
на последний коммит в ветке `rococo-v1`, удалите ./bin/polkadot и запустите 
```bash
./scripts/init.sh run
```

Обновите зависимости проекта коллатора 
```bash
cargo update
./scripts/init.sh build
```
Некоторые зависимости, вероятно, требуют новых функций инструментария Rust. Этот проект основан на версии Rust `nightly-2021-01-26`
Обновите версию инструментария Rust в ./scripts/config.sh перед сборкой.

## Взломайте парачейн
[Добавьте внешний паллет](https://substrate.dev/docs/en/tutorials/add-a-pallet/) - возможно, это должно быть в разделе "Узнать больше"?
## Узнать больше

Обратитесь к исходному
[Шаблону узла разработчика Substrate](https://github.com/substrate-developer-hub/substrate-node-template)
чтобы узнать больше о структуре этого проекта, его возможностях и способе реализации этих возможностей. Вы можете узнать больше о
[Пути блока парачейна](https://polkadot.network/the-path-of-a-parachain-block/) на
официальном блоге Polkadot.
[Паритетный семинар Cumulus](https://substrate.dev/cumulus-workshop/#/)